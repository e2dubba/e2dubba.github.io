<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bibliography</title>
    <script>
        const Url = 'https://api.zotero.org/groups/2356093/items?itemType=-attachment+%7C%7C+note';


        function getNextLink(links) {
            links = links.split(', ');
            let nextlink = links[0].split('; ');
            let link = nextlink[0]
            link =  link.substring(1, link.length-1)
            let text = nextlink[1].match(/"(.*?)"/)[0];
            console.log(text);
            return {
                'text': text, 
                'link': link 
            };
        };
        
        function totalResultsAndPager(totalResults, links) {
            let nav = document.createElement('div');
            nav.id = 'navid';
            const {text, link} = getNextLink(links);
            let total = document.getElementById('total-span');
            if (!total) {
                total = document.createElement('span');
                total.style.cssText = 'float;center';
                total.innerHTML = 'Number of Items: ' + totalResults;
                total.id = 'total-span'
                nav.appendChild(total);
            } 
            
            let forward = document.getElementById('pagerbutton');
            if (!forward) {
                console.log('Button does not exist');
                forward = document.createElement('button');
                forward.id = 'pagerbutton';
                forward.innerHTML = text;
            } else {
                forward.innerHTML = text;
                forward.removeEventListener('click', eventListenerDetails)
            }
            forward['data-link'] = link
            console.log('through the if conditions.... ')
            console.log(forward)

            nav.appendChild(forward);
            let totdiv = document.getElementById('TotalDiv');
            totdiv.appendChild(nav);
            pagerEventListener();
        };

        function bibParser(data) {
            let table = document.createElement('table');
            table.id = 'bibTable';
            let thead = document.createElement('thead');
            for (const col of ['Contributor', 'Title', 'Date']) {
                let th = document.createElement('th');
                th.innerHTML = col;
                thead.appendChild(th);
            };
            table.appendChild(thead);

            for (const item of data) {
                let bib = item.data;
                let tr = table.insertRow(-1);
                let authCell = tr.insertCell(-1);

                let contrib = bib.creators[0]['lastName']+ ', '+ bib.creators[0]['firstName'];
                authCell.innerHTML = contrib;
                for (const attrib of ['title', 'date']) {
                    let cell = tr.insertCell(-1);
                    cell.innerHTML = bib[attrib];
                }
                
            };

            let div = document.getElementById('TableDiv');
            div.appendChild(table)

        };
            

        function grabBibliography(url) {
            console.log(url);
            fetch(url)
              .then(resp=>{
                  let totalResults = resp.headers.get('Total-Results');
                  let links = resp.headers.get('Link');
                  totalResultsAndPager(totalResults, links);
                  return resp.json()})
              .then(data=>{bibParser(data)})
        };

        function eventListenerDetails() {
            let table = document.getElementById('TableDiv');
            let bibTable = document.getElementById('bibTable');
            table.removeChild(bibTable);
            //let navdiv = document.getElementById('Totaldiv');
            //let nav = document.getElementById('navid');
            // navdiv.removeChild(nav);
            let pagerbutton = document.getElementById('pagerbutton');
            console.log(pagerbutton['data-link']);
            

            grabBibliography(pagerbutton['data-link']);
        };

        function pagerEventListener() {
           document.getElementById('pagerbutton').addEventListener('click', eventListenerDetails);
        };

    </script>
</head>
<body>
    <div id="TotalDiv"></div>
    <div id="TableDiv"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            grabBibliography(Url);
        });
    </script>
    
</body>
</html>
